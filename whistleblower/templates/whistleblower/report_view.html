<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8">
    <title>Report Viewing Page</title>
    <!-- Note: Order matters here!! -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'whistleblower/style.css' %}">

</head>
<body>
    <header class="header">
        <div class="title">Report View</div>
        <div class="buttons">
            {% if user.is_site_admin %}
                <button class="button" onclick="goBackToAdmin()">Back To Home</button>
            {% else %}
                <button class="button" onclick="goBackToMyReports()">Back To My Reports</button>
            {% endif %}

        </div>
    </header>

    <div class="content">
        <p><Strong>Report Submitted By:</Strong> {{ current_report.user_name }}</p>
        {% if current_report_file != 'Not Provided' %}
            {% if current_report_file_type == '.pdf' %}
                <embed src="{{ current_report_file }}" height="400" width="600" type="application/pdf"/>

            {% elif current_report_file_type == '.txt' %}
                <iframe src="{{ current_report_file }}" height="400" width="600"></iframe>

            {% elif current_report_file_type == '.jpeg' or current_report_file_type == '.jpg' or current_report_file_type == '.png'%}
                <img src="{{ current_report_file }}" alt="Image" height="400" width="600"/>

            {% else %}
                <p>The reporter submitted a file, but it was an unsupported file format</p>
            {% endif %}
        {% endif %}

        <p style="word-break: break-word; width: 90%"><Strong>Description:</Strong> {{current_report.description}}</p>
        <p><Strong>Approximate Date:</Strong> {{current_report.date}}</p>
        <p><Strong>Approximate Time:</Strong> {{current_report.time}}</p>
        {% if current_report.status == 'n' %}
            <p><Strong>Status:</Strong> New</p>
        {% elif current_report.status == 'i' %}
            <p><Strong>Status:</Strong> In Review</p>
        {% elif current_report.status == 'r' %}
            <p><Strong>Status:</Strong> Resolved</p>
        {% endif %}

        <p id="adminNotes" style="word-break: break-word; width: 90%">
            {% if current_report.admin_notes and current_report.admin_notes != "" %}
                <strong>Admin Notes: </strong>{{ current_report.admin_notes }}
            {% else %}
                <strong>Admin Notes: </strong> No site admins have added notes to this report yet, please check back in the future!
            {% endif %}
        </p>

        {% if user.is_site_admin %}
            <form method="post" action="{% url 'reopen_report' current_report.id %}">
                {% csrf_token %}
                <label for="notes" class="form-label">Update Admin Notes:</label>
                <div class="textarea-wrapper">
                    <textarea id="notes" name="notes" class="form-control" required maxlength="1000">{% if current_report.admin_notes and current_report.admin_notes != 'None' %}{{ current_report.admin_notes }}{% endif %}</textarea>
                    <span id="charCount" class="text-muted">0/1000</span>
                </div>
                <div>
                    <button class="button" type="button" id="submitNotes" style="margin-top:10px; margin-bottom: 10px">Upload Notes</button>
                </div>
                {% if current_report.status == 'r' %}
                    <p><button class="button" type="submit">Reopen Report</button></p>
                {% else %}
                    <p><button class="button" type="submit" formaction="{% url 'resolve_report' current_report.id %}" id="resolveButton">Resolve Report</button></p>
                {% endif %}
            </form>
        {% endif %}

        {% if not user.is_site_admin %}
            <form id="deleteForm" method="post" action="{% url 'delete_report' current_report.id%}">
                {% csrf_token %}
                <p><button class="button" type="button" id="deleteButton" data-toggle="modal" data-target="#deleteModal">Delete Report</button></p>
            </form>
        {% endif %}
    </div>

    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Delete Report</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this report? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteButton">Delete</button>
                </div>
            </div>
        </div>
    </div>

  <footer class="footer">
      <div class="disclaimer">
          <p style="color:red;"><strong>Disclaimer:</strong> this website is a project for UVA CS 3240. As there is no one
          monitoring this project, reports made to it will have no effect. Additionally, no real information should be submitted
          to this webpage. If you are a UVA Student and want to report a hazing incident, please go
          <a href="https://justreportit.virginia.edu/">here</a> to do so. </p>
      </div>
  </footer>

    <script>

        function goBackToAdmin() {
            window.location.href = '/site_admin';
        }
        function goBackToMyReports() {
            window.location.href = '/my_reports';
        }

        $(document).ready(function() {
            $('#submitNotes').click(function(e) {
                e.preventDefault();  // Prevent default form submission
                $.ajax({
                    type: 'POST',
                    url: '{% url "set_report_notes" current_report.id %}',
                    data: {
                        'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val(),
                        'notes': $('#notes').val()  // Ensure this line correctly references the textarea
                    },
                    success: function(response) {
                        // Update the admin notes paragraph with the new notes from the response
                        if (response.notes){
                            $('#adminNotes').html('<strong>Admin Notes: </strong>' + response.notes);
                        }
                        else{
                            $('#adminNotes').html('<strong>Admin Notes: </strong> No site admins have added notes to this report yet, please check back in the future!');
                        }
                        // Clear the input field
                        $('input[name=notes]').val('');
                    },
                    error: function(xhr, errmsg, err) {
                        console.log("Error: " + xhr.status + ": " + xhr.responseText);
                    }
                });
            });
        });

        $(document).ready(function() {
            $('#resolveButton').click(function(e) {
                e.preventDefault();  // Prevent default form submission
                $.ajax({
                    type: 'POST',
                    url: '{% url "resolve_report" current_report.id %}',
                    data: {
                        'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val(),
                        'notes': $('#notes').val()  // Send the current notes with the resolve request
                    },
                    success: function(response) {
                        window.location.href = '/site_admin';  // Redirect after successful resolve
                    },
                    error: function(xhr, errmsg, err) {
                        console.log("Error: " + xhr.status + ": " + xhr.responseText);
                    }
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            var textarea = document.getElementById('notes');
            var charCount = document.getElementById('charCount');

            // Update character count on input
            textarea.addEventListener('input', function() {
                var count = textarea.value.length;
                charCount.textContent = count + '/1000';
            });
        });

        $(document).ready(function() {
            $('#confirmDeleteButton').click(function() {
                $('#deleteForm').submit();
            });
        });

    </script>


</body>

</html>


